spack:
#  include:
#  - dk.yaml
  view: false
  concretization: separately
  config::
    concretizer: original
    install_tree:
      root: /cm/shared/software/opt
      padded_length: False
    build_stage: $tempdir/user/spack-stage

  modules::
    default:
      # Where to install modules
      roots:
        tcl: /cm/shared/software/modules/borah-base
      # What type of modules to use
      enable:
        - tcl

      prefix_inspections:
        bin:
          - PATH
      tcl:
        blacklist_implicits: true
        hash_length: 0
#        naming_scheme: '{compiler.name}/{compiler.version}/{name}/{version}'
        all:
          autoload: none
          conflict:
          - '{name}'
          environment:
            set:
              '{name}_ROOT': '{prefix}'
#        mpich:
#          autoload: none
        projections:
#          all: '{name}/{version}-{compiler.name}-{compiler.version}'
          gcc: '{name}/{version}'
          intel-oneapi-compilers: 'oneapi/{version}'
          mpich: '{name}/{version}/{compiler.name}/{compiler.version}'
          intel-oneapi-mpi: '{name}/{version}/{compiler.name}/{compiler.version}'
          openmpi: '{name}/{version}/{compiler.name}/{compiler.version}'

  # Override all other settings so this is the only compiler visible to spack
  compilers::
  - compiler:
      paths:
        cc: /cm/shared/software/opt/linux-centos7-x86_64/gcc-12.1.0/intel-oneapi-compilers-2022.1.0-36rrpyy3bd5lvxl7xlip6q43vmywnpwl/compiler/2022.1.0/linux/bin/icx
        cxx: /cm/shared/software/opt/linux-centos7-x86_64/gcc-12.1.0/intel-oneapi-compilers-2022.1.0-36rrpyy3bd5lvxl7xlip6q43vmywnpwl/compiler/2022.1.0/linux/bin/icpx
        f77: /cm/shared/software/opt/linux-centos7-x86_64/gcc-12.1.0/intel-oneapi-compilers-2022.1.0-36rrpyy3bd5lvxl7xlip6q43vmywnpwl/compiler/2022.1.0/linux/bin/ifx
        fc: /cm/shared/software/opt/linux-centos7-x86_64/gcc-12.1.0/intel-oneapi-compilers-2022.1.0-36rrpyy3bd5lvxl7xlip6q43vmywnpwl/compiler/2022.1.0/linux/bin/ifx
      operating_system: centos7
      target: x86_64
      modules: []
      environment: {}
      extra_rpaths: []
      flags: {}
      spec: oneapi@2022.1.0
  - compiler:
      paths:
        cc: /cm/shared/software/opt/linux-centos7-x86_64/gcc-4.8.5/gcc-12.1.0-yztxqq4nafv7dyxkohfycsibetgfvrna/bin/gcc
        cxx: /cm/shared/software/opt/linux-centos7-x86_64/gcc-4.8.5/gcc-12.1.0-yztxqq4nafv7dyxkohfycsibetgfvrna/bin/g++
        f77: /cm/shared/software/opt/linux-centos7-x86_64/gcc-4.8.5/gcc-12.1.0-yztxqq4nafv7dyxkohfycsibetgfvrna/bin/gfortran
        fc: /cm/shared/software/opt/linux-centos7-x86_64/gcc-4.8.5/gcc-12.1.0-yztxqq4nafv7dyxkohfycsibetgfvrna/bin/gfortran
      operating_system: centos7
      target: x86_64
      modules: []
      environment: {}
      extra_rpaths: []
      flags: {}
      spec: gcc@12.1.0
  - compiler:
      paths:
        cc: /bin/gcc
        cxx: /bin/g++ 
        f77:  /bin/gfortran
        fc:  /bin/gfortran
      operating_system: centos7
      target: x86_64
      modules: []
      environment: {}
      extra_rpaths: []
      flags: {}
      spec: gcc@4.8.5

  packages: 

    cuda:
      variants: +allow-unsupported-compilers
      version:
      - 11.6.2

    mpich:
      variants: +cuda
      version:
      - 3.4.3

    openmpi:
      variants: +cuda
      version:
      - 3.1.6

    intel-oneapi-mpi:
#      variants: 
      version:
      - 2021.6.0

    intel-oneapi-compilers:
      version:
      - 2022.1.0
      externals:
#      - spec: intel-oneapi-compliers@2022.1.0%gcc@12.1.0 target=x86_64 ^patchelf@0.14.5
      - spec: intel-oneapi-compilers@2022.1.0%gcc@12.1.0 arch=linux-centos7-x86_64 ^patchelf@0.14.5%gcc@12.1.0 arch=linux-centos7-x86_64
        prefix: /cm/shared/software/opt/linux-centos7-x86_64/gcc-12.1.0/intel-oneapi-compilers-2022.1.0-36rrpyy3bd5lvxl7xlip6q43vmywnpwl
        buildable: False
    gcc:
      version:
      - 12.1.0
      externals:
      - spec: gcc@12.1.0%gcc@12.1.0 target=x86_64
        prefix: /cm/shared/software/opt/linux-centos7-x86_64/gcc-4.8.5/gcc-12.1.0-yztxqq4nafv7dyxkohfycsibetgfvrna
        buildable: False

  definitions:
  - libraries:
    - hdf5@1.10.7 +fortran +hl +shared +mpi
#    - hdf5@1.12.2 +fortran +shared +mpi

  specs:
#  - intel-oneapi-compilers@2022.1.0%gcc target=x86_64
  - intel-oneapi-compilers@2022.1.0%gcc@12.1.0 arch=linux-centos7-x86_64 
  - gcc@12.1.0%gcc@4.8.5 target=x86_64
  - matrix:
    - [ 'mpich@3.4.3+cuda^cuda+allow-unsupported-compilers', 'intel-oneapi-mpi@2021.6.0', 'openmpi@3.1.6+cuda^cuda+allow-unsupported-compilers' ]
    - [ '%gcc@12.1.0', '%oneapi@2022.1.0' ]
#    - [ 'target=x86_64' ]
    - [ 'target=x86_64', 'target=haswell', 'target=cascadelake' ]
#    exclude:
#    - mpich%oneapi

#    - [ $libraries ]
#    - [ '%gcc@12.1.0', '%oneapi@2022.1.0' ]
#    - [ '^mpich@4.0.2+cuda', '^intel-oneapi-mpi@2021.6.0', '^openmpi@4.1.3+cuda+pmi~pmix' ]

  mirrors::
    BSU:
      fetch:
        url: file:///cm/shared/software/mirror
        access_pair:
        - null
        - null
        access_token: null
        profile: null
        endpoint_url: null
      push:
        url: file:///cm/shared/software/mirror
        access_pair:
        - null
        - null
        access_token: null
        profile: null
        endpoint_url: null
